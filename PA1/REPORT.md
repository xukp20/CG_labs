## 图形学实验 PA1：光线投射

徐康平 计07 2020011016

### 代码逻辑

#### Sphere类

类中保存_center和\_radius成员

intersect方法的实现逻辑如下，参考教材上的算法：

- 检查射线起点是否在球内
- 计算oc在射线方向上的投影，从而判断射线的方向和球心的相对位置
  - 如果射线起点不在球内，且投影为负，说明球在射线的后方，没有交点
- 计算圆心到射线的距离，与半径比较
  - 如果超过半径，则无交点
  - 如果刚好相等，则只有一个交点，所以判定这个交点是否小于Hit保存的当前t，且大于tmin，是则更新Hit
  - 如果小于半径，则有两个交点，算出两个交点的t，先检查近的t是否满足条件，不满足则再判定远的交点，满足条件则更新Hit



#### Plane类

类中保存向量_n, float _d用于描述平面方程

intersect方法实现参考ppt中算法：

- 首先特判射线与平面法向量垂直的情况，此时无交点
  - 因为计算结果可能有误差，当内积小于1e-6时就当作没有交点
- 否则计算射线与平面交点的t，判断是否符合条件，是则更新Hit



#### Triangle类

类中保存了三个顶点的坐标a,b,c，使用顶点计算出法向量n

intersect参考ppt中给出的三角形与射线求交算法：

- 首先计算e1, e2, s三个向量
- 计算行列式时，使用三个列向量的混合积得到
- 之后代入Cramer法则求出t，β，γ
- 检查t，β，γ符合限制，即后两者均非负且和不大于1，另外t需要比tmin更大，小于当前的hit的t，是则更新Hit



#### Transform类

经过检查，框架中的transform类的方法都已经实现而且没有问题，所以没有修改



#### Group类

Group类中使用vector保存所有Object的指针，初始化时被赋值为固定长度的vector

intersect：

- 遍历所有非空的object，调用他们的isIntersect方法，这样Hit中会保存最近的合理交点的坐标
- 只要有一个object存在交点，那么就和Group有交，返回true



#### PerspectiveCamera类

camera基类中已经保存了center和三个方向向量，PerspectiveCamera的构造函数：

- 使用传入的图片宽高计算cx, cy，即cx, cy应在图片的中心，分别为二者的1/2

- 根据比例计算fx, fy：因为z取1，u取width时，得到的$d_{Rc}$的在y=0平面上与z轴所夹角度应为$angle/2$, 所以
  $$
  tan(angle/2) = \frac{(width - width/2)/fx}{1}
  $$
  所以
  $$
  fx = \frac{width}{2\ tan(angle/2)}
  $$
  同理fy为$\frac{height}{2tan(angle/2)}$

- 之后构造R矩阵，计算世界空间下的射线的起点和方向向量，得到所需Ray



#### Material类

参考作业文档中的Phong模型公式，计算Shade，只需要按照公式逐项计算即可，具体见代码



#### Main主逻辑

在main.cpp中，参考作业文档中提供的代码框架进行实现：

- 首先创建一个sceneParser读取配置文件，根据其camera的宽高信息构造新的Image对象
- 遍历每一个像素点，进行如下逻辑：
  - 通过Camera获取当前像素的射线
  - 获取所有物体的Group，检查是否有交点并获取交点
    - 如果有交点，遍历所有光源
      - 得到光源在交点处的光强，以及交点指向光源的向量
      - 使用交点处Material的Shade方法计算叠加的颜色，加到当前像素上
    - 如果没有交点，设置为背景颜色
- 保存绘制好的图像



### 代码参考

参考了教材上的算法和作业文档的算法

没有与同学讨论或者借鉴网上代码
